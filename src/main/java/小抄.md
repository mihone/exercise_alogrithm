# 项目介绍

# 挑战
1 数据量几十亿，峰值有1000多，如何优化系统保证es稳定性。
考虑稳定性的思路主要有三个方向
1，查询端
2，写入端
3，集群端
这三个方向都有相应的策略才能在整体上保证稳定。
查询端，思路是尽量减小检索范围，数据量小了，性能自然就会提高
优化有两点，1是按照门店分片，请求的80%来自单店检索，将这部分请求限制在单个分片，缩小检索范围，降低内存的影响。
2 字段定制化，根据查询场景设定合适的字段类型，关掉不必要的分词排序节省空间。
写入端，思路是平滑写入，且速度可控
具体措施有两点，第一是，所有的对es的更新都会通过加工组装后转发到同一个mq里，并且按照门店id进行分区，避免写并发占用es的cpu和内存资源
第二是客户端批量bulk写入，通过动态的配置控制bulk写入的并发数和批次大小。
集群端：思路是在集群和索引上整体对稳定性有帮助的
其一是集群机器按照主节点三地域，数据节点两地域进行配置，主副分片均匀分散在各个地域的机器上，保证单地域集群挂掉仍然可用
其二是每天定时段合并，清理删除数据，维持索引的总大小在一定体量上。
其三，有损降级，es完全不可用时，支持根据标签和商品基础信息查db，满足核心功能查询诉求。

